name: Smart Daily Activity

on:
  schedule:
    
    - cron: "0 22,2,6,10,14,18 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  smart-activity:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Generate smart activity
        run: |
          set -e

          PROJECT="${GITHUB_REPOSITORY##*/}"
          DAY="$(date -u +%A)"
          WEEK="$(date -u +%V)"
          DATE="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          FILE="activity-week-${WEEK}.log"
          COUNTER_FILE=".run-counter"

          # ðŸ”¢ Run counter
          if [ ! -f "$COUNTER_FILE" ]; then echo "0" > "$COUNTER_FILE"; fi
          RUN_COUNT=$(($(cat "$COUNTER_FILE") + 1))
          echo "$RUN_COUNT" > "$COUNTER_FILE"

          # ðŸ§  Commit-based status
          COMMITS=$(git rev-list --count HEAD)
          if [ "$COMMITS" -lt 20 ]; then
            STATUS="Early Development"
            TAG="research"
          elif [ "$COMMITS" -lt 100 ]; then
            STATUS="Active Development"
            TAG="dev"
          else
            STATUS="Stabilization & Cleanup"
            TAG="cleanup"
          fi

          # ðŸ“ˆ Weekly summary (Sunday only)
          SUMMARY=""
          if [ "$DAY" = "Sunday" ]; then
            WEEK_COMMITS=$(git rev-list --count --since="7 days ago" HEAD)
            SUMMARY="Weekly commits: $WEEK_COMMITS"
          fi

          # ðŸ” Hash signature
          SIGN_DATA="$PROJECT|$STATUS|$RUN_COUNT|$DATE"
          HASH=$(echo "$SIGN_DATA" | sha256sum | cut -d' ' -f1)

          {
            echo ""
            echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ"
            echo "â–ˆ   SMART ACTIVITY SYSTEM v1.1     â–ˆ"
            echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ"
            echo " Project : $PROJECT"
            echo " Status  : $STATUS"
            echo " Tag     : #$TAG"
            echo " Commits : $COMMITS"
            echo " Run     : #$RUN_COUNT"
            echo " Day     : $DAY"
            echo " Week    : #$WEEK"
            echo " Time    : $DATE"
            [ -n "$SUMMARY" ] && echo " Summary : $SUMMARY"
            echo " Hash    : $HASH"
            echo " Signature: imedkablavi"
            echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ"
          } >> "$FILE"

      - name: Commit & push
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "imedkablavi"
          git config user.email "76208805+imedkablavi@users.noreply.github.com"

          git add .

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: smart automated activity system"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
